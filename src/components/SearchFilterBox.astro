---
// æª”æ¡ˆè·¯å¾‘: src/components/SearchFilterBox.astro
// é€™æ˜¯æ‰€æœ‰æ–‡ç« å’Œåˆ†é¡é é¢ä½¿ç”¨çš„ã€Œæœå°‹èˆ‡åˆ†é¡å°è¦½ã€æ¨¡çµ„
import { getCollection } from 'astro:content';

interface Props {
  // ç”¨ä¾†åˆ¤æ–·ç•¶å‰é é¢æ˜¯å¦ç‚ºæŸå€‹åˆ†é¡é  (ä¾‹å¦‚: "ç”œé»é£Ÿè­œ")
  // å¦‚æœæ˜¯ï¼Œè©²åˆ†é¡çš„æŒ‰éˆ•æœƒè¢«é«˜äº®
  currentCategory?: string; 
}

const { currentCategory } = Astro.props;

// æŠ“å–æ‰€æœ‰æ–‡ç« ï¼ˆå·²éæ¿¾è‰ç¨¿ï¼‰
const allPosts = (await getCollection('blog')).filter(post => !post.data.draft);
// å–å¾—æ‰€æœ‰å”¯ä¸€çš„åˆ†é¡
const allCategories = allPosts.flatMap(post => post.data.category);
const uniqueCategories = [...new Set(allCategories)].filter(Boolean);
---

<div class="mb-8 p-4 bg-[var(--bg-card)] rounded-lg shadow-md space-y-4">
  
  <!-- 1. åˆ†é¡å°è¦½å€å¡Š -->
  <div class="space-y-3 border-b border-[var(--border-color)] pb-4">
    <h3 class="text-lg font-bold text-[var(--text-primary)]">æ–‡ç« åˆ†é¡</h3>
    <div class="flex flex-wrap gap-2">
      
      <!-- æ‰€æœ‰æ–‡ç« æŒ‰éˆ• -->
      <a href="/archive" class="text-xs font-medium text-white py-1 px-3 rounded-full transition-colors flex-shrink-0"
         class:list={[
           currentCategory === 'æ‰€æœ‰æ–‡ç« ' && 'bg-[var(--accent-color)] hover:bg-[var(--accent-hover)]',
           currentCategory !== 'æ‰€æœ‰æ–‡ç« ' && 'bg-gray-400 hover:bg-gray-500'
         ]}
      >
        æ‰€æœ‰æ–‡ç« 
      </a>
      
      <!-- å„å€‹åˆ†é¡é€£çµ -->
      {uniqueCategories.map(cat => (
        <a 
          href={`/category/${cat}`} 
          class="text-xs font-medium py-1 px-3 rounded-full transition-colors flex-shrink-0"
          class:list={[
            cat === currentCategory && 'bg-[var(--accent-color)] text-white hover:bg-[var(--accent-hover)]',
            cat !== currentCategory && 'bg-gray-100 text-[var(--text-secondary)] hover:bg-gray-200'
          ]}
        >
          {cat}
        </a>
      ))}
    </div>
  </div>

  <!-- 2. æœå°‹è¼¸å…¥æ¡† -->
  <div class="pt-2">
    <input 
      type="search" 
      id="search-input" 
      placeholder="åœ¨æ­¤é é¢ä¸­æœå°‹..."
      class="w-full px-3 py-2 rounded-md border border-[var(--border-color)] text-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]"
    >
  </div>

</div>

<!-- 
  ğŸ‘‡ æœå°‹ç¯©é¸ JavaScript 
  æ³¨æ„ï¼šé€™å€‹è…³æœ¬åªè² è²¬åŸ·è¡Œé é¢å…§çš„ã€Œç¯©é¸ã€ï¼Œä¸è™•ç†é»æ“Šåˆ†é¡æ¨™ç±¤å¾Œçš„ã€Œè·³è½‰ã€è¡Œç‚ºã€‚
-->
<script>
  document.addEventListener('astro:page-load', () => {
    const searchInput = document.getElementById('search-input');
    const articleListContainer = document.getElementById('article-list-container');
    const articleWrappers = articleListContainer?.querySelectorAll('.article-card-wrapper');
    const noResultsMessage = document.getElementById('no-results-message');

    if (!searchInput || !articleWrappers || !noResultsMessage) return;

    let currentSearch = '';
    
    // è®€å– URL åƒæ•¸ (ä¾†è‡ªé é¦–çš„æœå°‹)
    const urlParams = new URLSearchParams(window.location.search);
    const queryFromUrl = urlParams.get('q');

    // åˆå§‹åŒ–ï¼šå¦‚æœ URL æœ‰æœå°‹é—œéµå­—ï¼Œå‰‡å¡«å…¥ä¸¦åŸ·è¡Œç¯©é¸
    if (queryFromUrl) {
      (searchInput as HTMLInputElement).value = queryFromUrl;
      currentSearch = queryFromUrl.toLowerCase().trim();
    }

    function runSearchFilter() {
      let visibleCount = 0;
      const searchTerm = currentSearch; 

      articleWrappers.forEach(wrapper => {
        const el = wrapper as HTMLElement;
        const searchText = el.dataset.searchText || '';
        
        // æ¢ä»¶: æœå°‹æ–‡å­—
        const matchesSearch = searchTerm === '' || searchText.includes(searchTerm);

        if (matchesSearch) {
          el.style.display = 'block'; 
          visibleCount++;
        } else {
          el.style.display = 'none';
        }
      });

      noResultsMessage.style.display = visibleCount === 0 ? 'block' : 'none';
    }

    // ç›£è½æœå°‹æ¡†è¼¸å…¥
    searchInput.addEventListener('input', (e) => {
      currentSearch = (e.target as HTMLInputElement).value.toLowerCase().trim();
      runSearchFilter();
    });

    // é é¢è¼‰å…¥æ™‚ï¼Œç«‹å³åŸ·è¡Œä¸€æ¬¡ç¯©é¸
    runSearchFilter();
  });
</script>
