
---
// src/pages/blog/[...slug].astro
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
Â  const allPosts = (await getCollection('blog'))
    .filter(post => !post.data.draft) // ğŸ‘ˆ æ–°å¢ï¼šéæ¿¾æ‰æ‰€æœ‰ draft: true çš„æ–‡ç« 
    .sort(
Â  Â  (a, b) => new Date(a.data.publishDate).getTime() - new Date(b.data.publishDate).getTime()
Â  );

  return allPosts.map((post, index) => {
    const prevPost = index > 0 ? {
      slug: allPosts[index - 1].slug,
      title: allPosts[index - 1].data.title,
    } : null;

    const nextPost = index < allPosts.length - 1 ? {
      slug: allPosts[index + 1].slug,
      title: allPosts[index + 1].data.title,
    } : null;

    return {
      params: { slug: post.slug },
      props: { post, prevPost, nextPost },
    };
  });
}

type Props = {
  post: CollectionEntry<'blog'>;
  prevPost: { slug: string; title: string } | null;
  nextPost: { slug: string; title: string } | null;
}

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await post.render();
// å»ºç«‹ Schema.org çµæ§‹åŒ–è³‡æ–™
const siteUrl = Astro.site; // å–å¾— astro.config.mjs ä¸­çš„ 'site'

// ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ–°å¢ï¼šGoogle æœå°‹çš„åœ–ç‰‡ (å„ªå…ˆç”¨ 1:1 çš„ previewImageï¼Œé”æˆæ‚¨çš„ç›®æ¨™)
const googleSearchImage = new URL(post.data.previewImage || post.data.heroImage || '/images/og_default.png', siteUrl).href;

// 1. é€šç”¨æ–‡ç«  Schema (æ‰€æœ‰æ–‡ç« éƒ½æœ‰)
const blogPostingSchema = {
Â  "@context": "https://schema.org",
Â  "@type": "BlogPosting",
Â  "headline": post.data.title,
Â  "description": post.data.description,
Â  // å¿…é ˆæ˜¯çµ•å°è·¯å¾‘
Â  "image": googleSearchImage, // ğŸ‘ˆ ä¿®æ”¹ï¼šä½¿ç”¨æ–¹å½¢åœ–çµ¦ Google
Â  "datePublished": post.data.publishDate.toISOString(),
Â  "author": {
Â  Â  "@type": "Person",
Â  Â  "name": "KAE" 
Â  }
};

// 2. é£Ÿè­œ Schema (æ¢ä»¶å¼)
let recipeSchema = null;
// æª¢æŸ¥ .md æª”æ¡ˆä¸­æ˜¯å¦æœ‰ isRecipe: true ä¸”æä¾›äº†ææ–™å’Œæ­¥é©Ÿ
if (post.data.isRecipe && post.data.recipeIngredients && post.data.recipeInstructions) {
Â  recipeSchema = {
Â  Â  "@context": "https://schema.org/",
Â  Â  "@type": "Recipe",
Â  Â  "name": post.data.title,
Â  Â  "image": googleSearchImage, // ğŸ‘ˆ ä¿®æ”¹ï¼šä½¿ç”¨æ–¹å½¢åœ–çµ¦ Google
Â  Â  "description": post.data.description,
    "author": {
      "@type": "Person",
      "name": "KAE" // (æ‚¨å·²ä¿®æ”¹)
    },
    "datePublished": post.data.publishDate.toISOString(),
    
    // --- â–¼â–¼â–¼ ä»¥ä¸‹æ˜¯æ–°åŠ å…¥/ä¿®æ”¹çš„æ¬„ä½ â–¼â–¼â–¼ ---
    "keywords": post.data.tags?.join(', ') || "", // (æ–°) è‡ªå‹•æŠ“å– tags
    "recipeCategory": post.data.recipeCategory, // ä¾†è‡ª .md
    "prepTime": post.data.prepTime, // (æ–°) ä¾†è‡ª .md (ä¾‹å¦‚ "PT1H15M")
    "cookTime": post.data.cookTime, // (æ–°) ä¾†è‡ª .md (ä¾‹å¦‚ "PT15M")
    "recipeCuisine": post.data.recipeCuisine, // (æ–°) ä¾†è‡ª .md (ä¾‹å¦‚ "æ—¥å¼ç”œé»")
    // --- â–²â–²â–² æ–°æ¬„ä½çµæŸ â–²â–²â–² ---

    "recipeIngredient": post.data.recipeIngredients, // ä¾†è‡ª .md
    "recipeInstructions": post.data.recipeInstructions.map(step => ({ // ä¾†è‡ª .md
      "@type": "HowToStep",
      "text": step
    })),
  };
}
---

<BaseLayout
Â  pageTitle={post.data.title}
Â  description={post.data.description}
Â  ogImage={post.data.heroImage} >

  <div class="max-w-3xl mx-auto">

    <nav class="text-sm text-[var(--text-secondary)] mb-4">
      <a href="/archive" class="hover:text-[var(--accent-color)]">æ‰€æœ‰æ–‡ç« </a>
      <span class="mx-2">&gt;</span>
      <a href={`/category/${post.data.category[0]}`} class="hover:text-[var(--accent-color)]">
        {post.data.category[0]}
      </a>
    </nav>

    <article class="bg-[var(--bg-card)] rounded-xl shadow-lg p-8 md:p-12">

      <header class="mb-8">
        <div class="mb-4 flex flex-wrap gap-2">
          {post.data.category.map(cat => (
            <a
              href={`/category/${cat}`}
              class="text-sm font-medium text-white bg-[var(--accent-color)] py-1 px-3 rounded-full hover:bg-[var(--accent-hover)] transition-colors"
            >
              {cat}
            </a>
          ))}
        </div>

        <h1 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)] leading-tight mb-4 whitespace-pre-line">
          {post.data.title}
        </h1>

        <span class="text-base text-gray-500">
          {new Date(post.data.publishDate).toLocaleDateString('zh-TW')}ãƒ»ç”± ã‹ãˆ (KAE) æ’°å¯«
        </span>
      </header>

      {headings.filter(h => h.depth === 2 || h.depth === 3).length > 0 && (
        <div class="bg-gray-100 p-6 rounded-lg mb-8 border border-[var(--border-color)]">
          <h2 class="text-xl font-bold text-[var(--text-primary)] mb-4">æ–‡ç« ç›®æ¬¡</h2>
          <ul class="space-y-2">
            {headings
              .filter(h => h.depth === 2 || h.depth === 3)
              .map(heading => (
                <li class={heading.depth === 3 ? 'ml-4' : ''}>
                  <a
                    href={`#${heading.slug}`}
                    class="text-[var(--text-secondary)] hover:text-[var(--accent-color)] transition-colors"
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
          </ul>
        </div>
      )}

      <div class="prose max-w-none">
        <Content />
      </div>

      <footer class="mt-8 pt-6 border-t border-[var(--border-color)]">
        
        {post.data.tags && post.data.tags.length > 0 && (
          <div class="flex flex-wrap items-center gap-2">
            <span class="text-sm font-semibold text-[var(--text-secondary)]">Tags:</span>
            {post.data.tags.map(tag => (
              <span class="px-2 py-0.5 rounded-md text-gray-700 text-xs" style="background-color: #e7f0e2;">
                {tag}
              </span>
            ))}
          </div>
        )}

        <div class={`flex flex-wrap gap-2 ${post.data.tags && post.data.tags.length > 0 ? 'mt-8' : ''}`}>
          
          <button 
            id="copy-link-btn" 
            class="text-sm font-medium text-white bg-[var(--accent-color)] py-1.5 px-3 rounded-full hover:bg-[var(--accent-hover)] transition-colors"
          >
            è¤‡è£½é€£çµ
          </button>

          <button 
            id="native-share-btn" 
            class="hidden text-sm font-medium text-white bg-[var(--accent-color)] py-1.5 px-3 rounded-full hover:bg-[var(--accent-hover)] transition-colors"
          >
            åˆ†äº«æ­¤æ–‡
          </button>
        </div>
      </footer>
      </article>

    <nav class="mt-8 grid grid-cols-1 gap-4">
      {prevPost && (
        <a
          href={`/blog/${prevPost.slug}`}
          class="block bg-[var(--bg-card)] p-4 rounded-lg shadow-md hover:shadow-lg transition-all text-left"
        >
          <span class="text-sm text-gray-500">&larr; ä¸Šä¸€ç¯‡æ–‡ç« </span>
          <span class="block text-base font-semibold text-[var(--accent-color)] mt-1">
            {prevPost.title}
          </span>
        </a>
      )}
      {nextPost && (
        <a
          href={`/blog/${nextPost.slug}`}
          class="block bg-[var(--bg-card)] p-4 rounded-lg shadow-md hover:shadow-lg transition-all text-left"
        >
          <span class="text-sm text-gray-500">ä¸‹ä¸€ç¯‡æ–‡ç«  &rarr;</span>
          <span class="block text-base font-semibold text-[var(--accent-color)] mt-1">
            {nextPost.title}
          </span>
        </a>
      )}
</nav>
  </div> <script type="application/ld+json" set:html={JSON.stringify(blogPostingSchema)} />
  
  {recipeSchema && (
    <script type="application/ld+json" set:html={JSON.stringify(recipeSchema)} />
  )}
  <script>
    // å»ºç«‹ä¸€å€‹å‡½å¼ä¾†è¨­å®šæŒ‰éˆ•ï¼Œé€™æ¨£ astro:page-load æ‰èƒ½é‡è¤‡å‘¼å«
    function setupShareButtons() {
      const copyButton = document.getElementById('copy-link-btn') as HTMLButtonElement;
      const shareButton = document.getElementById('native-share-btn') as HTMLButtonElement;

      // --- 1. åŸç”Ÿåˆ†äº« (Native Share) æŒ‰éˆ•é‚è¼¯ ---
      if (navigator.share && shareButton) {
        // å¦‚æœç€è¦½å™¨æ”¯æ´ navigator.shareï¼Œå°±é¡¯ç¤ºã€Œåˆ†äº«æ­¤æ–‡ã€æŒ‰éˆ•
        shareButton.classList.remove('hidden');
        
        // åŠ ä¸Šé»æ“Šäº‹ä»¶
        if (shareButton.dataset.listenerAttached !== 'true') {
          shareButton.addEventListener('click', async () => {
            try {
              await navigator.share({
                title: document.title, // åˆ†äº«çš„æ¨™é¡Œ (è‡ªå‹•æŠ“å–é é¢æ¨™é¡Œ)
                text: document.querySelector('meta[name="description"]')?.getAttribute('content') || '', // åˆ†äº«çš„æè¿° (è‡ªå‹•æŠ“å–é é¢æè¿°)
                url: window.location.href, // åˆ†äº«çš„ç¶²å€ (ç•¶å‰ç¶²å€)
              });
            } catch (err) {
              console.error('Error with native share: ', err);
            }
          });
          shareButton.dataset.listenerAttached = 'true';
        }
      }

      // --- 2. è¤‡è£½é€£çµ (Copy Link) æŒ‰éˆ•é‚è¼¯ ---
      if (copyButton) {
        if (copyButton.dataset.listenerAttached !== 'true') {
          copyButton.addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href)
              .then(() => {
                const originalText = copyButton.textContent;
                copyButton.textContent = 'å·²è¤‡è£½ï¼';
                copyButton.disabled = true;
                
                setTimeout(() => {
                  copyButton.textContent = originalText;
                  copyButton.disabled = false;
                }, 2000);
              })
              .catch(err => {
                console.error('ç„¡æ³•è¤‡è£½é€£çµ: ', err);
                copyButton.textContent = 'è¤‡è£½å¤±æ•—';
              });
          });
          copyButton.dataset.listenerAttached = 'true';
        }
      }
    }

    // ç›£è½ Astro é é¢è½‰å ´
    document.addEventListener('astro:page-load', setupShareButtons);
    // ä¹Ÿåœ¨é é¢åˆæ¬¡è¼‰å…¥æ™‚åŸ·è¡Œ
    setupShareButtons();
  </script>

</BaseLayout>
