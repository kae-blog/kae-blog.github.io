---
// src/pages/blog/[...slug].astro
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

// --- 修正 #7: 修改 getStaticPaths 來傳遞上一篇/下一篇文章 ---
export async function getStaticPaths() {
  const allPosts = (await getCollection('blog')).sort(
    (a, b) => new Date(a.data.publishDate).getTime() - new Date(b.data.publishDate).getTime()
  ); // 依日期排序 (舊 -> 新)

  return allPosts.map((post, index) => {
    // 如果 index > 0，就有上一篇文章 (較舊)
    const prevPost = index > 0 ? {
      slug: allPosts[index - 1].slug,
      title: allPosts[index - 1].data.title,
    } : null;

    // 如果 index < 總數-1，就有下一篇文章 (較新)
    const nextPost = index < allPosts.length - 1 ? {
      slug: allPosts[index + 1].slug,
      title: allPosts[index + 1].data.title,
    } : null;

    return {
      params: { slug: post.slug },
      props: { post, prevPost, nextPost }, // 把文章和前後篇一起傳出去
    };
  });
}

type Props = {
  post: CollectionEntry<'blog'>;
  // --- 修正 #7: 接收 props ---
  prevPost: { slug: string; title: string } | null;
  nextPost: { slug: string; title: string } | null;
}

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await post.render();
---
<BaseLayout 
  pageTitle={post.data.title}
  description={post.data.description}
>
    
    <div class="max-w-3xl mx-auto">
      
      <nav class="text-sm text-[var(--text-secondary)] mb-4">
        <a href="/archive" class="hover:text-[var(--accent-color)]">所有文章</a>
        <span class="mx-2">&gt;</span>
        <a href={`/category/${post.data.category[0]}`} class="hover:text-[var(--accent-color)]">
          {post.data.category[0]}
        </a>
      </nav>

        <article class="bg-[var(--bg-card)] rounded-xl shadow-lg p-8 md:p-12">
            
            <header class="mb-8">
                <div class="mb-4 flex flex-wrap gap-2">
                  {post.data.category.map(cat => (
                    <a href={`/category/${cat}`} class="text-sm font-medium text-white bg-[var(--accent-color)] py-1 px-3 rounded-full hover:bg-[var(--accent-hover)] transition-colors">
                      {cat}
                    </a>
                  ))}
                </div>
    
                <h1 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)] leading-tight mb-4 whitespace-pre-line">
                    {post.data.title}
                </h1>
                <span class="text-base text-gray-500">
                    {new Date(post.data.publishDate).toLocaleDateString('zh-TW')}・由 かえ (KAE) 撰寫
                </span>
              
                          </header>
    
            {headings.filter(h => h.depth === 2 || h.depth === 3).length > 0 && (
                <div class="bg-gray-100 p-6 rounded-lg mb-8 border border-[var(--border-color)]">
                    <h2 class="text-xl font-bold text-[var(--text-primary)] mb-4">文章目次</h2>
                    <ul class="space-y-2">
                        {headings
                            .filter(h => h.depth === 2 || h.depth === 3)
                            .map(heading => (
                                <li class={heading.depth === 3 ? 'ml-4' : ''}>
                                    <a 
                                        href={`#${heading.slug}`}
                                        class="text-[var(--text-secondary)] hover:text-[var(--accent-color)] transition-colors"
                                    >
                                        {heading.text}
                                    </a>
                                </li>
                            ))
                        }
                    </ul>
                </div>
            )}
    
            <div class="prose max-w-none">
                <Content />
            </div>

            {post.data.tags && post.data.tags.length > 0 && (
              <footer class="mt-8 pt-6 border-t border-[var(--border-color)]">
                <div class="flex flex-wrap gap-2">
                  {post.data.tags.map(tag => (
                    <span class="px-3 py-1 rounded-full text-sm text-white" style="background-color: var(--accent-color);">
                      {tag}
                    </span>
                  ))}
                </div>
              </footer>
            )}

        </article>

        <nav class="mt-8 grid grid-cols-2 gap-6">
          <div>
            {prevPost && (
              <a href={`/blog/${prevPost.slug}`} class="block bg-[var(--bg-card)] p-4 rounded-lg shadow-md hover:shadow-lg transition-all text-left">
                <span class="text-sm text-gray-500">&larr; 上一篇文章</span>
                <span class="block text-base font-semibold text-[var(--accent-color)] mt-1 truncate">{prevPost.title}</span>
              </a>
            )}
          </div>
          <div class="text-right">
            {nextPost && (
              <a href={`/blog/${nextPost.slug}`} class="block bg-[var(--bg-card)] p-4 rounded-lg shadow-md hover:shadow-lg transition-all text-right">
                <span class="text-sm text-gray-500">下一篇文章 &rarr;</span>
                <span class="block text-base font-semibold text-[var(--accent-color)] mt-1 truncate">{nextPost.title}</span>
              </a>
            )}
          </div>
        </nav>

    </div>
</BaseLayout>
