---
// src/pages/blog/[...slug].astro
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
// 1. å¼•å…¥æ–°å…ƒä»¶
import CommentSystem from '../../components/CommentSystem.astro';

export async function getStaticPaths() {
  const allPosts = (await getCollection('blog')).sort(
    (a, b) => new Date(a.data.publishDate).getTime() - new Date(b.data.publishDate).getTime()
  );

  return allPosts.map((post, index) => {
    const prevPost = index > 0 ? {
      slug: allPosts[index - 1].slug,
      title: allPosts[index - 1].data.title,
    } : null;

    const nextPost = index < allPosts.length - 1 ? {
      slug: allPosts[index + 1].slug,
      title: allPosts[index + 1].data.title,
    } : null;

    return {
      params: { slug: post.slug },
      props: { post, prevPost, nextPost },
    };
  });
}

type Props = {
  post: CollectionEntry<'blog'>;
  prevPost: { slug: string; title: string } | null;
  nextPost: { slug: string; title: string } | null;
}

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await post.render();
const siteUrl = Astro.site;

// Google æœå°‹çš„åœ–ç‰‡
const googleSearchImage = new URL(post.data.previewImage || post.data.heroImage || '/images/og_default.png', siteUrl).href;

// 2. å®šç¾© Google Apps Script ç¶²å€ (é›†ä¸­ç®¡ç†)
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxw-KeAWJtanPCNGpVyydYoeLrQqMUZ_lvOqegTmPi7CUZCDF-Fz4k37iJU6XilsDpZgg/exec";

// 3. å®šç¾©ã€Œæ‰‹å‹•ç½®é ‚ç•™è¨€ã€çš„è³‡æ–™ (é€™å°±æ˜¯æ‚¨è¦çš„ Props é¸å¡«æ§åˆ¶)
// å¦‚æœæŸç¯‡æ–‡ç« ä¸æƒ³é¡¯ç¤ºï¼Œæ‚¨å¯ä»¥æŠŠé€™è£¡è¨­ç‚º nullï¼Œæˆ–è€…é‡å°ç‰¹å®š slug åšåˆ¤æ–·
const manualCommentData = {
  name: "KAE (ç«™é•·)",
  date: "2025/11/15",
  content: "æ­¡è¿ç•™è¨€ï¼æœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥åœ¨é€™è£¡æå‡ºå–”ã€‚",
  // avatarChar: "K", // é€™è¡Œå¯ä»¥åˆªæ‰æˆ–ç•™è‘—ç•¶å‚™ç”¨
  avatarSrc: "/images/kae_logo.png" // ğŸ‘ˆ æ–°å¢é€™è¡Œï¼ŒæŒ‡å®šæ‚¨çš„åœ–ç‰‡è·¯å¾‘
};

// Schema å®šç¾© (ä¿æŒä¸è®Š)
const blogPostingSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.data.title,
  "description": post.data.description,
  "image": googleSearchImage,
  "datePublished": post.data.publishDate.toISOString(),
  "author": {
    "@type": "Person",
    "name": "KAE"
  }
};

let recipeSchema = null;
if (post.data.isRecipe && post.data.recipeIngredients && post.data.recipeInstructions) {
  recipeSchema = {
    "@context": "https://schema.org/",
    "@type": "Recipe",
    "name": post.data.title,
    "image": googleSearchImage,
    "description": post.data.description,
    "author": {
      "@type": "Person",
      "name": "KAE"
    },
    "datePublished": post.data.publishDate.toISOString(),
    "keywords": post.data.tags?.join(', ') || "",
    "recipeCategory": post.data.recipeCategory,
    "prepTime": post.data.prepTime,
    "cookTime": post.data.cookTime,
    "recipeCuisine": post.data.recipeCuisine,
    "recipeIngredient": post.data.recipeIngredients,
    "recipeInstructions": post.data.recipeInstructions.map(step => ({
      "@type": "HowToStep",
      "text": step
    })),
  };
}
---

<BaseLayout
  pageTitle={post.data.title}
  description={post.data.description}
  ogImage={post.data.heroImage}
>

  <div class="max-w-3xl mx-auto">

    <nav class="text-sm text-[var(--text-secondary)] mb-4">
      <a href="/archive" class="hover:text-[var(--accent-color)]">æ‰€æœ‰æ–‡ç« </a>
      <span class="mx-2">&gt;</span>
      <a href={`/category/${post.data.category[0]}`} class="hover:text-[var(--accent-color)]">
        {post.data.category[0]}
      </a>
    </nav>

    <article class="bg-[var(--bg-card)] rounded-xl shadow-lg p-8 md:p-12">

      <header class="mb-8">
        <div class="mb-4 flex flex-wrap gap-2">
          {post.data.category.map(cat => (
            <a
              href={`/category/${cat}`}
              class="text-sm font-medium text-white bg-[var(--accent-color)] py-1 px-3 rounded-full hover:bg-[var(--accent-hover)] transition-colors"
            >
              {cat}
            </a>
          ))}
        </div>

        <h1 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)] leading-tight mb-4 whitespace-pre-line">
          {post.data.title}
        </h1>

        <span class="text-base text-gray-500">
          {new Date(post.data.publishDate).toLocaleDateString('zh-TW')}ãƒ»ç”± KAE æ’°å¯«
        </span>
      </header>

      {headings.filter(h => h.depth === 2 || h.depth === 3).length > 0 && (
        <div class="bg-gray-100 p-6 rounded-lg mb-8 border border-[var(--border-color)]">
          <h2 class="text-xl font-bold text-[var(--text-primary)] mb-4">æ–‡ç« ç›®æ¬¡</h2>
          <ul class="space-y-2">
            {headings
              .filter(h => h.depth === 2 || h.depth === 3)
              .map(heading => (
                <li class={heading.depth === 3 ? 'ml-4' : ''}>
                  <a
                    href={`#${heading.slug}`}
                    class="text-[var(--text-secondary)] hover:text-[var(--accent-color)] transition-colors"
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
          </ul>
        </div>
      )}

      <div class="prose max-w-none">
        <Content />
      </div>

      <footer class="mt-8 pt-6 border-t border-[var(--border-color)]">
        
{post.data.tags && post.data.tags.length > 0 && (
          <div class="flex flex-wrap items-center gap-2">
            <span class="text-sm font-semibold text-[var(--text-secondary)]">Tags:</span>
            {post.data.tags.map(tag => (
              <a 
                href={`/archive?q=${encodeURIComponent(tag)}`}
                class="px-2 py-0.5 rounded-md text-gray-700 text-xs bg-[#e7f0e2] hover:bg-[var(--accent-color)] hover:text-white transition-colors cursor-pointer"
                style="text-decoration: none;"
              >
                {tag}
              </a>
            ))}
          </div>
        )}

        <div class={`flex flex-wrap gap-2 ${post.data.tags && post.data.tags.length > 0 ? 'mt-8' : ''}`}>
          
          <button 
            id="copy-link-btn" 
            class="text-sm font-medium text-white bg-[var(--accent-color)] py-1.5 px-3 rounded-full hover:bg-[var(--accent-hover)] transition-colors"
          >
            è¤‡è£½é€£çµ
          </button>

          <button 
            id="native-share-btn" 
            class="hidden text-sm font-medium text-white bg-[var(--accent-color)] py-1.5 px-3 rounded-full hover:bg-[var(--accent-hover)] transition-colors"
          >
            åˆ†äº«æ­¤æ–‡
          </button>
        </div>
      </footer>
    </article>

    <CommentSystem 
      articleSlug={post.slug} 
      apiUrl={GOOGLE_SCRIPT_URL}
      manualComment={manualCommentData} 
    />

    <nav class="mt-8 grid grid-cols-1 gap-4">
      {prevPost && (
        <a
          href={`/blog/${prevPost.slug}`}
          class="block bg-[var(--bg-card)] p-4 rounded-lg shadow-md hover:shadow-lg transition-all text-left"
        >
          <span class="text-sm text-gray-500">&larr; ä¸Šä¸€ç¯‡æ–‡ç« </span>
          <span class="block text-base font-semibold text-[var(--accent-color)] mt-1">
            {prevPost.title}
          </span>
        </a>
      )}
      {nextPost && (
        <a
          href={`/blog/${nextPost.slug}`}
          class="block bg-[var(--bg-card)] p-4 rounded-lg shadow-md hover:shadow-lg transition-all text-left"
        >
          <span class="text-sm text-gray-500">ä¸‹ä¸€ç¯‡æ–‡ç«  &rarr;</span>
          <span class="block text-base font-semibold text-[var(--accent-color)] mt-1">
            {nextPost.title}
          </span>
        </a>
      )}
    </nav>

  </div>

  <script type="application/ld+json" set:html={JSON.stringify(blogPostingSchema)} />
  
  {recipeSchema && (
    <script type="application/ld+json" set:html={JSON.stringify(recipeSchema)} />
  )}

  <script>
    function setupShareButtons() {
      const copyButton = document.getElementById('copy-link-btn');
      const shareButton = document.getElementById('native-share-btn');

      if (navigator.share && shareButton) {
        shareButton.classList.remove('hidden');
        if (shareButton.dataset.listenerAttached !== 'true') {
          shareButton.addEventListener('click', async () => {
            try {
              const descMeta = document.querySelector('meta[name="description"]');
              const textContent = descMeta ? descMeta.getAttribute('content') : '';
              await navigator.share({
                title: document.title,
                text: textContent,
                url: window.location.href,
              });
            } catch (err) {
              console.error('Error with native share: ', err);
            }
          });
          shareButton.dataset.listenerAttached = 'true';
        }
      }

      if (copyButton) {
        if (copyButton.dataset.listenerAttached !== 'true') {
          copyButton.addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href)
              .then(() => {
                const originalText = copyButton.textContent;
                copyButton.textContent = 'å·²è¤‡è£½ï¼';
                copyButton.setAttribute('disabled', 'true');
                setTimeout(() => {
                  copyButton.textContent = originalText;
                  copyButton.removeAttribute('disabled');
                }, 2000);
              })
              .catch(err => {
                console.error('ç„¡æ³•è¤‡è£½é€£çµ: ', err);
                copyButton.textContent = 'è¤‡è£½å¤±æ•—';
              });
          });
          copyButton.dataset.listenerAttached = 'true';
        }
      }
    }

    document.addEventListener('astro:page-load', setupShareButtons);
    setupShareButtons();
  </script>

</BaseLayout>
