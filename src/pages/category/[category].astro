---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const categories = new Set<string>();
  allPosts.forEach((post) => {
    post.data.category.forEach((c: string) => categories.add(c));
  });

  return Array.from(categories).map((category) => ({
    params: { category },
  }));
}

// 取得目前頁面的 category
const { category } = Astro.params;

// 取得此分類的文章
const allPosts = await getCollection("blog");
const postsInCategory = allPosts
  .filter((post) => post.data.category.includes(category))
  .sort(
    (a, b) =>
      new Date(b.data.publishDate).getTime() -
      new Date(a.data.publishDate).getTime()
  );

// description 截斷函數
const truncate = (text: string, maxLength = 120) =>
  text.length > maxLength ? text.slice(0, maxLength) + "…" : text;
---

<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{category} - KAE的雜記</title>
    <link rel="stylesheet" href="/_astro/global.css" />
  </head>
  <body class="bg-[var(--bg-main)]">
    <header>
      <!-- 你的 header 可重用 -->
    </header>

    <main class="container mx-auto px-6 py-12">
      <h1 class="text-3xl font-bold text-[var(--text-primary)] mb-6 border-b border-[var(--border-color)]">
        {category}
      </h1>

      {postsInCategory.length === 0 ? (
        <p class="text-[var(--text-secondary)]">此分類尚無文章。</p>
      ) : (
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {postsInCategory.map((post: CollectionEntry<"blog">) => (
            <article
              class="bg-[var(--bg-card)] rounded-xl shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden"
              key={post.slug}
            >
              {/* 上方圖片 1:1 */}
              <div class="w-full aspect-square overflow-hidden">
                <img
                  src={post.data.previewImage || "/images/default.png"}
                  alt={post.data.title.replace(/\n/g, " ")}
                  class="w-full h-full object-cover"
                />
              </div>

              <div class="p-4">
                <h2 class="text-lg font-bold text-[var(--text-primary)] mb-2 line-clamp-2 whitespace-pre-line">
                  <a
                    href={`/blog/${post.slug}`}
                    class="hover:text-[var(--accent-color)] transition-colors"
                  >
                    {post.data.title}
                  </a>
                </h2>
                <p class="text-sm text-[var(--text-secondary)] line-clamp-3 mb-2">
                  {truncate(post.data.description || "")}
                </p>

                <div class="flex flex-wrap items-center justify-between text-xs text-gray-500 gap-2">
                  <span>{new Date(post.data.publishDate).toLocaleDateString()}</span>
                  <div class="flex flex-wrap gap-1">
                    {post.data.category.slice(0, 3).map((tag: string) => (
                      <span
                        class="px-2 py-0.5 rounded-md text-gray-700"
                        style="background-color:#e7f0e2;"
                      >
                        {tag}
                      </span>
                    ))}
                  </div>
                  <a
                    href={`/blog/${post.slug}`}
                    class="text-[var(--accent-color)] hover:underline ml-auto"
                  >
                    閱讀 →
                  </a>
                </div>
              </div>
            </article>
          ))}
        </div>
      )}
    </main>

    <footer class="text-center text-[var(--text-secondary)] py-10 mt-12 border-t border-[var(--border-color)]">
      <p>&copy; 2025 KAE的雜記. All rights reserved.</p>
    </footer>
  </body>
</html>
